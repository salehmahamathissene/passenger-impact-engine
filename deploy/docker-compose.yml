version: "3.9"

services:
  pie-web:
    container_name: pie-web
    image: nginx:alpine
    ports:
      - "8010:80"
    restart: unless-stopped
    volumes:
      - pie_site:/usr/share/nginx/html:ro
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/ | grep -q '<title>PIE Dashboard</title>'"]
      interval: 30s
      timeout: 5s
      retries: 5

  pie-worker:
    container_name: pie-worker
    image: pie:latest
    restart: unless-stopped
    volumes:
      - pie_out:/app/out:rw
      - pie_site:/app/site:rw
      - ./configs:/app/configs:ro
      - ./worker.sh:/app/worker.sh:ro
    command: ["/bin/bash", "/app/worker.sh"]
    healthcheck:
      test: ["CMD-SHELL", "test -f /app/site/index.html"]
      interval: 30s
      timeout: 5s
      retries: 5

volumes:
  pie_out: {}
  pie_site: {}
